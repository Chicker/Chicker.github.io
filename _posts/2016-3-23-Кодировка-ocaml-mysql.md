---
layout: post
title: Настраиваем utf-8 кодировку в ocaml-mysql (OCaml MySql)
---

При использовании библиотеки `ocaml-mysql` предпочтительным способом подключения
к БД MySql является использование функции `quick_connect` определенной в модуле
`Mysql`.

При настройках по умолчанию, результат запроса, содержащий не-ASCII символы
(например, кириллицу) будет содержать знаки вопроса (`?`) на месте этих самих
не-ASCII символов. Сперва я подумал, что тут что-то не так с выводом не-ASCII
текста на консоль (так как я для
тестирования mysql-библиотеки использовал `utop`), и благополучно забыл об этом,
до тех пор пока не сконвертировал данные в `JSON` и не вывел в браузер -
получил те же самые знаки вопроса.

## Решение №1

В списке параметров функции установки соединения с БД Mysql (`quick_connect`)
есть необязательный аргумент `options`, представляющий собой список параметров
подключения к БД.

Вот не полный список всех параметров:

```
type db_option =
  | OPT_COMPRESS
  | OPT_NAMED_PIPE
  | ....
  | SET_CHARSET_DIR of string
  | SET_CHARSET_NAME of string
  | SHARED_MEMORY_BASE_NAME of string
  | OPT_FOUND_ROWS

```

Одно из решений - это установка параметра `SET_CHARSET_NAME` в списке опций при
подключений к БД:

```
let db = Mysql.quick_connect
        ~options:[Mysql.SET_CHARSET_NAME "utf8"]
        ~database:"my_database"
        ~user:"user"
        ~password:"password" ()
```

## Решение №2

MySql допускает установку кодировки, предпочитаемую клиентом, посредством
выполнения sql-запроса определенного содержания:

```
Mysql.exec db "SET NAMES utf8 COLLATE utf8_unicode_ci"
```

Я выполняю этот запрос сразу после установки соединения с БД и до его закрытия.
